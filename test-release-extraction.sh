#!/bin/bash

# æµ‹è¯•ä»ŽRELEASE.mdæå–å‘å¸ƒè¯´æ˜Žçš„è„šæœ¬

VERSION="v1.6.38"

echo "æ­£åœ¨æµ‹è¯•æå–ç‰ˆæœ¬ $VERSION çš„å‘å¸ƒè¯´æ˜Ž..."
echo "================================"

# ä»ŽRELEASE.mdä¸­æå–å¯¹åº”ç‰ˆæœ¬çš„å‘å¸ƒè¯´æ˜Ž
if [ -f "RELEASE.md" ]; then
  # æŸ¥æ‰¾ç‰ˆæœ¬æ ‡é¢˜è¡Œ
  START_LINE=$(grep -n "^## $VERSION" RELEASE.md | head -1 | cut -d: -f1)
  
  if [ -n "$START_LINE" ]; then
    echo "æ‰¾åˆ°ç‰ˆæœ¬ $VERSION åœ¨ç¬¬ $START_LINE è¡Œ"
    
    # æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜è¡Œï¼ˆä½œä¸ºç»“æŸä½ç½®ï¼‰
    NEXT_VERSION_LINE=$(tail -n +$((START_LINE + 1)) RELEASE.md | grep -n "^## v" | head -1 | cut -d: -f1)
    
    if [ -n "$NEXT_VERSION_LINE" ]; then
      # è®¡ç®—å®žé™…çš„ç»“æŸè¡Œå·
      END_LINE=$((START_LINE + NEXT_VERSION_LINE - 1))
      echo "ä¸‹ä¸€ä¸ªç‰ˆæœ¬åœ¨ç›¸å¯¹ä½ç½® $NEXT_VERSION_LINEï¼Œå®žé™…ç»“æŸè¡Œ $END_LINE"
      # æå–ç‰ˆæœ¬è¯´æ˜Žï¼ˆè·³è¿‡ç‰ˆæœ¬æ ‡é¢˜è¡Œå’Œåˆ†éš”çº¿ï¼‰
      RELEASE_NOTES=$(sed -n "$((START_LINE + 1)),$((END_LINE - 1))p" RELEASE.md | sed '/^---$/d' | sed '/^$/N;/^\n$/d')
    else
      echo "æ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œæå–åˆ°æ–‡ä»¶æœ«å°¾"
      # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œæå–åˆ°æ–‡ä»¶æœ«å°¾
      RELEASE_NOTES=$(tail -n +$((START_LINE + 1)) RELEASE.md | sed '/^---$/d' | sed '/^$/N;/^\n$/d')
    fi
    
    # å¦‚æžœæå–çš„å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜Ž
    if [ -z "$RELEASE_NOTES" ]; then
      RELEASE_NOTES="### ðŸŽ¯ æ›´æ–°å†…å®¹\n- å¸¸è§„æ›´æ–°å’Œä¼˜åŒ–\n- ä¿®å¤å·²çŸ¥é—®é¢˜\n- æå‡ç”¨æˆ·ä½“éªŒ"
      echo "æå–çš„å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜Ž"
    else
      echo "æˆåŠŸæå–å‘å¸ƒè¯´æ˜Ž"
    fi
  else
    # å¦‚æžœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜Ž
    RELEASE_NOTES="### ðŸŽ¯ æ›´æ–°å†…å®¹\n- å¸¸è§„æ›´æ–°å’Œä¼˜åŒ–\n- ä¿®å¤å·²çŸ¥é—®é¢˜\n- æå‡ç”¨æˆ·ä½“éªŒ"
    echo "æ²¡æœ‰æ‰¾åˆ°ç‰ˆæœ¬ $VERSIONï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜Ž"
  fi
else
  # å¦‚æžœRELEASE.mdæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜Ž
  RELEASE_NOTES="### ðŸŽ¯ æ›´æ–°å†…å®¹\n- å¸¸è§„æ›´æ–°å’Œä¼˜åŒ–\n- ä¿®å¤å·²çŸ¥é—®é¢˜\n- æå‡ç”¨æˆ·ä½“éªŒ"
  echo "RELEASE.mdæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜Ž"
fi

echo "================================"
echo "æå–çš„å‘å¸ƒè¯´æ˜Žï¼š"
echo "================================"
echo -e "$RELEASE_NOTES"
echo "================================"

# å°†å‘å¸ƒè¯´æ˜Žä¿å­˜åˆ°è¾“å‡ºæ–‡ä»¶
echo -e "$RELEASE_NOTES" > test_release_notes.txt

# æ·»åŠ ä¸‹è½½è¯´æ˜Žå’Œç³»ç»Ÿè¦æ±‚
cat >> test_release_notes.txt << 'EOF'

### ðŸ“¥ ä¸‹è½½è¯´æ˜Ž
- **Windows**: ä¸‹è½½ `.exe` æ–‡ä»¶ç›´æŽ¥å®‰è£…
- **macOS**: ä¸‹è½½ `.dmg` æ–‡ä»¶å®‰è£…
- **Linux**: ä¸‹è½½ `.AppImage` æ–‡ä»¶ï¼Œæ·»åŠ æ‰§è¡Œæƒé™åŽè¿è¡Œ

### ðŸ’» ç³»ç»Ÿè¦æ±‚
- Windows 10/11 (64ä½)
- macOS 10.15+ (64ä½)
- Linux (64ä½)
- å¯é€‰ï¼šLibreOfficeï¼ˆç”¨äºŽPPTé¢„è§ˆåŠŸèƒ½ï¼‰
EOF

echo "å®Œæ•´çš„å‘å¸ƒè¯´æ˜Žå·²ä¿å­˜åˆ° test_release_notes.txt"
echo "æ–‡ä»¶å†…å®¹ï¼š"
echo "================================"
cat test_release_notes.txt
echo "================================"