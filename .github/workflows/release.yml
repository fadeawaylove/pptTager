name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # å½“æ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼Œå¦‚ v1.0.0

permissions:
  contents: write

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest, ubuntu-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build and package (Windows)
      if: matrix.os == 'windows-latest'
      run: npm run build:win
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and package (macOS)
      if: matrix.os == 'macos-latest'
      run: npm run build:mac
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Build and package (Linux)
      if: matrix.os == 'ubuntu-latest'
      run: npm run build:linux
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Upload artifacts (Windows)
      if: matrix.os == 'windows-latest'
      uses: actions/upload-artifact@v4
      with:
        name: windows-build
        path: dist/*.exe
        
    - name: Upload artifacts (macOS)
      if: matrix.os == 'macos-latest'
      uses: actions/upload-artifact@v4
      with:
        name: macos-build
        path: dist/*.dmg
        
    - name: Upload artifacts (Linux)
      if: matrix.os == 'ubuntu-latest'
      uses: actions/upload-artifact@v4
      with:
        name: linux-build
        path: dist/*.AppImage

  release:
    needs: build
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Get version from tag
      id: get_version
      run: |
        echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
        
    - name: Extract release notes from RELEASE.md
      id: extract_notes
      run: |
        VERSION="v${{ steps.get_version.outputs.version }}"
        
        # ä»RELEASE.mdä¸­æå–å¯¹åº”ç‰ˆæœ¬çš„å‘å¸ƒè¯´æ˜
        if [ -f "RELEASE.md" ]; then
          # æŸ¥æ‰¾ç‰ˆæœ¬æ ‡é¢˜è¡Œ
          START_LINE=$(grep -n "^## $VERSION" RELEASE.md | head -1 | cut -d: -f1)
          
          if [ -n "$START_LINE" ]; then
            # æŸ¥æ‰¾ä¸‹ä¸€ä¸ªç‰ˆæœ¬æ ‡é¢˜è¡Œï¼ˆä½œä¸ºç»“æŸä½ç½®ï¼‰
            NEXT_VERSION_LINE=$(tail -n +$((START_LINE + 1)) RELEASE.md | grep -n "^## v" | head -1 | cut -d: -f1)
            
            if [ -n "$NEXT_VERSION_LINE" ]; then
              # è®¡ç®—å®é™…çš„ç»“æŸè¡Œå·
              END_LINE=$((START_LINE + NEXT_VERSION_LINE - 1))
              # æå–ç‰ˆæœ¬è¯´æ˜ï¼ˆè·³è¿‡ç‰ˆæœ¬æ ‡é¢˜è¡Œå’Œåˆ†éš”çº¿ï¼‰
              RELEASE_NOTES=$(sed -n "$((START_LINE + 1)),$((END_LINE - 1))p" RELEASE.md | sed '/^---$/d' | sed '/^$/d' | sed 's/\\n/\n/g')
            else
              # å¦‚æœæ²¡æœ‰æ‰¾åˆ°ä¸‹ä¸€ä¸ªç‰ˆæœ¬ï¼Œæå–åˆ°æ–‡ä»¶æœ«å°¾
              RELEASE_NOTES=$(tail -n +$((START_LINE + 1)) RELEASE.md | sed '/^---$/d' | sed '/^$/d' | sed 's/\\n/\n/g')
            fi
            
            # å¦‚æœæå–çš„å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜
            if [ -z "$RELEASE_NOTES" ]; then
              RELEASE_NOTES="### ğŸ¯ æ›´æ–°å†…å®¹\n- å¸¸è§„æ›´æ–°å’Œä¼˜åŒ–\n- ä¿®å¤å·²çŸ¥é—®é¢˜\n- æå‡ç”¨æˆ·ä½“éªŒ"
            fi
          else
            # å¦‚æœæ²¡æœ‰æ‰¾åˆ°å¯¹åº”ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜
            RELEASE_NOTES="### ğŸ¯ æ›´æ–°å†…å®¹\n- å¸¸è§„æ›´æ–°å’Œä¼˜åŒ–\n- ä¿®å¤å·²çŸ¥é—®é¢˜\n- æå‡ç”¨æˆ·ä½“éªŒ"
          fi
        else
          # å¦‚æœRELEASE.mdæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜
          RELEASE_NOTES="### ğŸ¯ æ›´æ–°å†…å®¹\n- å¸¸è§„æ›´æ–°å’Œä¼˜åŒ–\n- ä¿®å¤å·²çŸ¥é—®é¢˜\n- æå‡ç”¨æˆ·ä½“éªŒ"
        fi
        
        # å°†å‘å¸ƒè¯´æ˜ä¿å­˜åˆ°è¾“å‡ºæ–‡ä»¶
        printf "%s\n\n### ğŸ“¥ ä¸‹è½½è¯´æ˜\n- **Windows**: ä¸‹è½½ .exe æ–‡ä»¶ç›´æ¥å®‰è£…\n- **macOS**: ä¸‹è½½ .dmg æ–‡ä»¶å®‰è£…\n- **Linux**: ä¸‹è½½ .AppImage æ–‡ä»¶ï¼Œæ·»åŠ æ‰§è¡Œæƒé™åè¿è¡Œ\n\n### ğŸ’» ç³»ç»Ÿè¦æ±‚\n- Windows 10/11 (64ä½)\n- macOS 10.15+ (64ä½)\n- Linux (64ä½)\n- å¯é€‰ï¼šLibreOfficeï¼ˆç”¨äºPPTé¢„è§ˆåŠŸèƒ½ï¼‰" "$RELEASE_NOTES" > release_notes.txt
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: PPTæ ‡ç­¾ç®¡ç†å™¨ v${{ steps.get_version.outputs.version }}
        tag_name: ${{ github.ref }}
        body_path: release_notes.txt
        files: |
          windows-build/*
          macos-build/*
          linux-build/*
        draft: false
        prerelease: false
        make_latest: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}